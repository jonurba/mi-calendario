<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>Calendario</title>
<link rel="manifest" href="manifest.json">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Calendario">
<meta name="theme-color" content="#7c5cfc">
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&family=Plus+Jakarta+Sans:wght@700;800;900&display=swap" rel="stylesheet">
<style>
  /* MIDNIGHT â€“ morado oscuro premium */
  :root {
    --bg: #09080f; --surface: #100e1c; --surface2: #17152a;
    --border: #221f38; --text: #ededff; --text2: #6060a0;
    --accent: #8060ff; --accent2: #ff5090;
    --accent-glow: rgba(128,96,255,0.3);
    --gradient: linear-gradient(135deg,#8060ff,#ff5090);
    --bg-fx: radial-gradient(ellipse at 15% 0%, rgba(128,96,255,0.14) 0%, transparent 55%),
             radial-gradient(ellipse at 85% 100%, rgba(255,80,144,0.09) 0%, transparent 50%);
  }
  /* SAGE â€“ verde salvia natural */
  [data-theme="aurora"] {
    --bg: #080f09; --surface: #0f1a10; --surface2: #152218;
    --border: #1e3022; --text: #eaf5ec; --text2: #508060;
    --accent: #6abf80; --accent2: #4a9e6a;
    --accent-glow: rgba(106,191,128,0.22);
    --gradient: linear-gradient(135deg,#6abf80,#4a9e6a);
    --bg-fx: radial-gradient(ellipse at 40% 0%, rgba(106,191,128,0.11) 0%, transparent 60%),
             radial-gradient(ellipse at 80% 95%, rgba(74,158,106,0.07) 0%, transparent 50%);
  }
  /* GOLDEN HOUR â€“ dorado Ã¡mbar, superficies cÃ¡lidas */
  [data-theme="golden"] {
    --bg: #100900; --surface: #1c1100; --surface2: #271800;
    --border: #3a2500; --text: #fff5d8; --text2: #907040;
    --accent: #ffb830; --accent2: #ff7020;
    --accent-glow: rgba(255,184,48,0.3);
    --gradient: linear-gradient(135deg,#ffb830,#ff5a20);
    --bg-fx: radial-gradient(ellipse at 60% 0%, rgba(255,184,48,0.16) 0%, transparent 55%),
             radial-gradient(ellipse at 10% 100%, rgba(255,90,32,0.10) 0%, transparent 55%);
  }
  /* SAKURA â€“ rosa japonÃ©s claro */
  [data-theme="sakura"] {
    --bg: #fff2f6; --surface: #ffffff; --surface2: #ffecf2;
    --border: #f5c8da; --text: #280a1a; --text2: #b06075;
    --accent: #e03068; --accent2: #ff6898;
    --accent-glow: rgba(224,48,104,0.18);
    --gradient: linear-gradient(135deg,#e03068,#ff6898);
    --bg-fx: radial-gradient(ellipse at 85% 5%, rgba(224,48,104,0.09) 0%, transparent 50%),
             radial-gradient(ellipse at 15% 95%, rgba(255,104,152,0.07) 0%, transparent 50%);
  }
  /* DEEP OCEAN â€“ azul marino profundo */
  [data-theme="ocean"] {
    --bg: #010810; --surface: #051420; --surface2: #091e30;
    --border: #0e2a40; --text: #d0eeff; --text2: #2e6080;
    --accent: #28a8ff; --accent2: #28ffe0;
    --accent-glow: rgba(40,168,255,0.28);
    --gradient: linear-gradient(135deg,#28a8ff,#28ffe0);
    --bg-fx: radial-gradient(ellipse at 50% 100%, rgba(40,168,255,0.18) 0%, transparent 65%),
             radial-gradient(ellipse at 5% 10%, rgba(40,255,224,0.07) 0%, transparent 50%);
  }
  /* OBSIDIAN â€“ carbÃ³n minimalista */
  [data-theme="obsidian"] {
    --bg: #060606; --surface: #101010; --surface2: #181818;
    --border: #262626; --text: #f0f0f0; --text2: #565656;
    --accent: #e0e0e0; --accent2: #a0a0a0;
    --accent-glow: rgba(224,224,224,0.12);
    --gradient: linear-gradient(135deg,#ffffff,#909090);
    --bg-fx: none;
  }

  /* ===== MODO CLARO â€“ se aplica al body ===== */
  body.light-mode { filter:none; }
  body.light-mode { --bg:#f4f4ff; --surface:#ffffff; --surface2:#eeecff; --border:#d8d0ff; --text:#1a1040; --text2:#7060b0; }
  body.light-mode [data-theme="aurora"] { --bg:#f2faf4; --surface:#ffffff; --surface2:#e8f5ec; --border:#c8e8d0; --text:#0e2018; --text2:#508060; }
  body.light-mode [data-theme="golden"] { --bg:#fffbf0; --surface:#ffffff; --surface2:#fff5d8; --border:#f0dfa0; --text:#1a1000; --text2:#907040; }
  body.light-mode [data-theme="sakura"] { --bg:#fff2f6; --surface:#ffffff; --surface2:#ffecf2; --border:#f5c8da; --text:#280a1a; --text2:#b06075; }
  body.light-mode [data-theme="ocean"] { --bg:#f0f8ff; --surface:#ffffff; --surface2:#e0f0ff; --border:#b0d8f8; --text:#021830; --text2:#2e6080; }
  body.light-mode [data-theme="obsidian"] { --bg:#f8f8f8; --surface:#ffffff; --surface2:#f0f0f0; --border:#d8d8d8; --text:#101010; --text2:#606060; --accent:#303030; --accent2:#606060; --gradient:linear-gradient(135deg,#303030,#606060); }
  body { font-family:'Outfit',sans-serif; background:var(--bg); color:var(--text); min-height:100vh; overflow-x:hidden; transition:background 0.5s,color 0.5s; }
  body::before {
    content:''; position:fixed; inset:0; z-index:0; pointer-events:none;
    background: var(--bg-fx);
  }
  /* Superficies con ligero tinte del acento para cohesiÃ³n */
  .event-card, .setting-row, .cat-edit-row, .modal {
    backdrop-filter: blur(8px);
  }
  [data-theme="golden"] .event-card,
  [data-theme="golden"] .setting-row { background: rgba(28,17,0,0.95); }
  [data-theme="golden"] .app-header { border-bottom: 1px solid rgba(255,184,48,0.1); }
  [data-theme="golden"] .month-label { color: #ffcc60; }
  [data-theme="sakura"] .month-label { color: #e03068; }
  [data-theme="aurora"] .month-label { color: #7ad090; }
  [data-theme="ocean"] .month-label { color: #60c8ff; }
  [data-theme="obsidian"] .app-title { background: linear-gradient(135deg,#fff,#888) !important; -webkit-background-clip:text !important; }
  .phone-wrapper { display:block; padding:0; min-height:100vh; background:transparent; position:relative; z-index:1; }
  .phone-frame { width:100%; min-height:100vh; background:transparent; border-radius:0; border:none; box-shadow:none; overflow:hidden; position:relative; transition:background 0.5s; }
  .status-bar { display:none; }
  .notch { display:none; }
  .app { padding:0 0 90px; }

  /* HEADER */
  .app-header { padding:16px 20px 12px; display:flex; justify-content:space-between; align-items:center; }
  .app-title { font-family:'Plus Jakarta Sans',sans-serif; font-size:26px; font-weight:900; background:var(--gradient); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text; letter-spacing:-0.5px; }
  .icon-btn { width:38px; height:38px; border-radius:12px; background:var(--surface2); border:1px solid var(--border); color:var(--text2); display:flex; align-items:center; justify-content:center; cursor:pointer; font-size:16px; transition:all 0.2s; }
  .icon-btn:hover { background:var(--accent); color:white; border-color:var(--accent); }

  /* MONTH NAV */
  .month-nav { display:flex; justify-content:space-between; align-items:center; padding:0 20px 8px; }
  .month-label { font-size:18px; font-weight:700; cursor:pointer; }
  .nav-arrows { display:flex; gap:4px; }
  .nav-arrow { width:32px; height:32px; border-radius:10px; background:var(--surface2); border:1px solid var(--border); color:var(--text2); display:flex; align-items:center; justify-content:center; cursor:pointer; font-size:14px; transition:all 0.2s; }
  .nav-arrow:hover { background:var(--accent); color:white; }

  /* VIEW TABS */
  .view-tabs { display:flex; margin:0 20px 12px; background:var(--surface2); border-radius:12px; padding:3px; border:1px solid var(--border); }
  .view-tab { flex:1; padding:7px; text-align:center; font-size:11px; font-weight:600; border-radius:9px; cursor:pointer; color:var(--text2); transition:all 0.2s; white-space:nowrap; }
  .view-tab.active { background:var(--gradient); color:white; box-shadow:0 2px 16px var(--accent-glow); }

  /* CALENDAR */
  .calendar-container { padding:0 20px; }
  .weekdays { display:grid; grid-template-columns:repeat(7,1fr); text-align:center; font-size:11px; font-weight:600; color:var(--text2); margin-bottom:8px; text-transform:uppercase; letter-spacing:0.5px; }
  .days-grid { display:grid; grid-template-columns:repeat(7,1fr); gap:4px; }
  .day-cell { aspect-ratio:1/1.3; display:flex; flex-direction:column; align-items:center; justify-content:center; border-radius:12px; cursor:pointer; font-size:14px; font-weight:500; position:relative; transition:all 0.2s; user-select:none; }
  .day-cell:hover { filter:brightness(1.12); }
  .day-cell.other-month { color:var(--text2); opacity:0.35; }
  .day-cell.today { border:3px solid var(--accent); color:var(--text); font-weight:800; }
  .day-cell.selected:not(.today) { border:2px solid var(--accent); }
  .day-cell.multi-selected { background:var(--accent-glow) !important; border:2px solid var(--accent) !important; }
  .event-dots { display:flex; gap:3px; position:absolute; bottom:6px; }
  .event-dot { width:6px; height:6px; border-radius:50%; }
  /* Ensure numbers always readable in light themes */
  [data-theme="pastel"] .day-cell:not(.today):not(.day-colored) { color:#2a1a4a; }
  [data-theme="pastel"] .day-cell.other-month { color:#8877aa; opacity:0.4; }
  [data-theme="pastel"] .day-cell.today { color:white; }
  .event-dots { display:flex; gap:3px; position:absolute; bottom:6px; }
  .event-dot { width:6px; height:6px; border-radius:50%; }

  /* EVENTS */
  .events-section { padding:16px 20px 0; }
  .section-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; }
  .section-title { font-size:16px; font-weight:700; }
  .add-btn { width:36px; height:36px; border-radius:12px; background:var(--gradient); color:white; display:flex; align-items:center; justify-content:center; cursor:pointer; font-size:20px; font-weight:300; border:none; box-shadow:0 4px 16px var(--accent-glow); transition:transform 0.2s,box-shadow 0.2s; }
  .add-btn:hover { transform:scale(1.1); box-shadow:0 6px 24px var(--accent-glow); }
  .event-card { background:var(--surface); border:1px solid var(--border); border-radius:16px; padding:12px 14px; margin-bottom:8px; display:flex; gap:12px; align-items:center; cursor:pointer; transition:all 0.2s; }
  .event-card:hover { background:var(--surface2); transform:translateX(2px); }
  .event-info { flex:1; min-width:0; }
  .event-name { font-size:14px; font-weight:600; margin-bottom:2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .event-meta { font-size:11px; color:var(--text2); display:flex; gap:6px; align-items:center; flex-wrap:wrap; }
  .event-cat-badge { padding:2px 8px; border-radius:20px; font-size:10px; font-weight:600; white-space:nowrap; }
  .event-time-badge { background:var(--surface2); padding:4px 10px; border-radius:8px; font-size:11px; font-weight:600; color:var(--text2); flex-shrink:0; white-space:nowrap; }
  .reminder-badge { display:inline-flex; align-items:center; gap:3px; background:rgba(252,184,92,0.15); color:#fcb85c; padding:2px 7px; border-radius:8px; font-size:10px; font-weight:600; white-space:nowrap; }
  .no-events { text-align:center; color:var(--text2); padding:30px; font-size:13px; }
  .no-events-icon { font-size:36px; margin-bottom:8px; }

  /* WEEKLY */
  .weekly-view { padding:0 20px; }
  .week-row { display:flex; gap:6px; overflow-x:auto; padding-bottom:8px; }
  .week-row::-webkit-scrollbar { display:none; }
  .week-day-col { flex:0 0 calc((100% - 36px)/7); }
  .week-day-header { text-align:center; margin-bottom:6px; cursor:pointer; }
  .week-day-name { font-size:9px; color:var(--text2); font-weight:600; text-transform:uppercase; }
  .week-day-num { width:28px; height:28px; border-radius:8px; display:flex; align-items:center; justify-content:center; margin:3px auto 0; font-size:12px; font-weight:700; }
  .week-day-num.today { border:3px solid var(--accent); color:var(--text); font-weight:800; }
  .week-event-pill { border-radius:6px; margin-bottom:2px; font-size:7px; padding:2px 3px; color:white; font-weight:600; overflow:hidden; white-space:nowrap; text-overflow:ellipsis; cursor:pointer; min-height:18px; line-height:14px; }
  .week-empty-slot { height:18px; border-radius:6px; background:var(--surface2); border:1px dashed var(--border); margin-bottom:2px; }

  /* DAILY */
  .daily-view { padding:0 20px; }
  .daily-date { font-size:28px; font-weight:800; margin-bottom:4px; }
  .daily-date-sub { font-size:13px; color:var(--text2); margin-bottom:16px; }
  .time-slot { display:flex; gap:12px; margin-bottom:2px; min-height:52px; align-items:flex-start; padding-top:8px; }
  .time-label { font-size:11px; color:var(--text2); width:36px; flex-shrink:0; font-weight:500; padding-top:2px; }
  .time-line { flex:1; border-top:1px solid var(--border); padding-top:4px; min-height:44px; }
  .timeline-event { border-radius:10px; padding:6px 10px; margin-bottom:2px; cursor:pointer; color:white; font-size:12px; font-weight:600; transition:transform 0.15s; }
  .timeline-event:hover { transform:scale(1.02); }
  .timeline-event-time { font-size:10px; opacity:0.8; font-weight:400; }

  /* FILTER VIEW */
  .filter-view { padding:0 20px; }
  .filter-header { padding:16px 0 12px; }
  .filter-subtitle { font-size:12px; color:var(--text2); font-weight:600; text-transform:uppercase; letter-spacing:1px; }
  .filter-title { font-size:22px; font-weight:800; margin-top:2px; }
  .cat-filter-all { border-radius:14px; padding:12px 16px; cursor:pointer; border:2px solid var(--border); background:var(--surface2); display:flex; align-items:center; gap:12px; transition:all 0.2s; margin-bottom:10px; }
  .cat-filter-all.active { border-color:var(--accent); background:rgba(124,92,252,0.1); }
  .cat-filter-grid { display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-bottom:16px; }
  .cat-filter-card { border-radius:16px; padding:14px; cursor:pointer; border:2px solid transparent; transition:all 0.25s; }
  .cat-filter-card.active { border-color:currentColor; transform:scale(1.02); }
  .cat-filter-icon { font-size:26px; margin-bottom:6px; }
  .cat-filter-name { font-size:13px; font-weight:700; }
  .cat-filter-count { font-size:11px; opacity:0.7; margin-top:2px; }
  .filter-month-group { margin-bottom:18px; }
  .filter-month-header { font-size:12px; font-weight:700; color:var(--text2); text-transform:uppercase; letter-spacing:1px; margin-bottom:8px; padding-bottom:6px; border-bottom:1px solid var(--border); }

  /* SETTINGS */
  .settings-view { display:none; padding:0 20px; }
  .setting-section { margin-bottom:20px; }
  .setting-section-title { font-size:13px; font-weight:700; color:var(--text2); text-transform:uppercase; letter-spacing:1px; margin-bottom:10px; }
  .setting-row { background:var(--surface); border:1px solid var(--border); border-radius:14px; padding:14px; display:flex; align-items:center; justify-content:space-between; margin-bottom:6px; }
  .setting-row-label { font-size:14px; font-weight:600; }
  .setting-row-sub { font-size:11px; color:var(--text2); margin-top:2px; }
  .toggle { width:46px; height:26px; background:var(--surface2); border-radius:14px; position:relative; cursor:pointer; transition:background 0.2s; flex-shrink:0; }
  .toggle.on { background:var(--accent); }
  .toggle::after { content:''; position:absolute; top:3px; left:3px; width:20px; height:20px; border-radius:50%; background:white; transition:left 0.2s; box-shadow:0 2px 6px rgba(0,0,0,0.3); }
  .toggle.on::after { left:23px; }
  .theme-grid { display:grid; grid-template-columns:repeat(3,1fr); gap:8px; }
  .theme-card { border-radius:14px; padding:12px; cursor:pointer; border:2px solid transparent; transition:all 0.25s; }
  .theme-card.selected { border-color:var(--accent); box-shadow:0 0 0 1px var(--accent), 0 4px 20px var(--accent-glow); }
  .theme-card-name { font-size:11px; font-weight:700; margin-top:6px; }
  .theme-card-sub { font-size:9px; opacity:0.65; margin-top:1px; }
  .theme-preview-dots { display:flex; gap:4px; }
  .theme-preview-dots span { width:12px; height:12px; border-radius:50%; }
  /* Cat editor */
  .cat-edit-row { background:var(--surface); border:1px solid var(--border); border-radius:14px; padding:12px 14px; margin-bottom:8px; }
  .cat-edit-top { display:flex; align-items:center; gap:10px; margin-bottom:10px; }
  .cat-icon-big { font-size:22px; cursor:pointer; width:38px; height:38px; display:flex; align-items:center; justify-content:center; border-radius:10px; background:var(--surface2); border:1px solid var(--border); flex-shrink:0; }
  .cat-name-input { flex:1; background:var(--surface2); border:1px solid var(--border); border-radius:10px; padding:8px 12px; color:var(--text); font-family:'Outfit',sans-serif; font-size:13px; font-weight:600; outline:none; min-width:0; }
  .cat-name-input:focus { border-color:var(--accent); }
  .cat-color-dots { display:flex; gap:6px; flex-wrap:wrap; }
  .cat-color-dot { width:22px; height:22px; border-radius:8px; cursor:pointer; border:2px solid transparent; transition:all 0.15s; flex-shrink:0; }
  .cat-color-dot.selected { border-color:white; transform:scale(1.2); }
  .cat-delete-btn { width:28px; height:28px; border-radius:8px; background:rgba(252,92,92,0.15); color:#fc5c5c; border:none; font-size:13px; cursor:pointer; display:flex; align-items:center; justify-content:center; flex-shrink:0; }
  .add-cat-btn { width:100%; padding:12px; border-radius:12px; background:rgba(124,92,252,0.1); border:2px dashed var(--accent); color:var(--accent); font-family:'Outfit',sans-serif; font-size:13px; font-weight:700; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:6px; transition:all 0.2s; }
  .add-cat-btn:hover { background:rgba(124,92,252,0.2); }

  /* BOTTOM NAV */
  .bottom-nav { position:fixed; bottom:0; left:50%; transform:translateX(-50%); width:390px; background:var(--surface); border-top:1px solid var(--border); display:flex; padding:10px 0 24px; z-index:50; }
  .nav-item { flex:1; display:flex; flex-direction:column; align-items:center; gap:3px; cursor:pointer; color:var(--text2); font-size:10px; font-weight:600; transition:color 0.2s; }
  .nav-item.active { color:var(--accent); }
  .nav-icon { font-size:22px; }

  /* MODALS */
  .modal-overlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.7); z-index:200; backdrop-filter:blur(4px); align-items:flex-end; justify-content:center; }
  .modal-overlay.open { display:flex; }
  .modal { width:390px; max-height:88vh; background:var(--surface); border-radius:28px 28px 0 0; padding:24px 20px 36px; border:1px solid var(--border); border-bottom:none; overflow-y:auto; animation:slideUp 0.35s cubic-bezier(0.16,1,0.3,1); }
  @keyframes slideUp { from{transform:translateY(100%);opacity:0} to{transform:translateY(0);opacity:1} }
  .modal-handle { width:40px; height:4px; background:var(--border); border-radius:4px; margin:0 auto 20px; }
  .modal-title { font-size:20px; font-weight:700; margin-bottom:16px; }
  .form-group { margin-bottom:14px; }
  .form-label { font-size:12px; font-weight:600; color:var(--text2); margin-bottom:6px; text-transform:uppercase; letter-spacing:0.5px; display:block; }
  .form-input { width:100%; padding:12px 14px; background:var(--surface2); border:1px solid var(--border); border-radius:12px; color:var(--text); font-family:'Outfit',sans-serif; font-size:14px; outline:none; transition:border-color 0.2s; }
  .form-input:focus { border-color:var(--accent); }
  .cats-picker { display:flex; gap:8px; flex-wrap:wrap; }
  .cat-pill { padding:7px 12px; border-radius:20px; font-size:11px; font-weight:600; cursor:pointer; border:2px solid transparent; opacity:0.6; transition:all 0.2s; white-space:nowrap; }
  .cat-pill.selected { opacity:1; border-color:currentColor; }
  .color-picker-row { display:flex; gap:8px; flex-wrap:wrap; }
  .color-swatch { width:30px; height:30px; border-radius:10px; cursor:pointer; border:3px solid transparent; transition:all 0.2s; }
  .color-swatch.selected { border-color:var(--text); transform:scale(1.15); }
  .time-row { display:flex; gap:8px; }
  .form-submit { width:100%; padding:14px; background:var(--gradient); color:white; border:none; border-radius:14px; font-family:'Outfit',sans-serif; font-size:15px; font-weight:700; cursor:pointer; margin-top:8px; box-shadow:0 4px 20px var(--accent-glow); }
  .form-cancel { width:100%; padding:12px; background:transparent; color:var(--text2); border:1px solid var(--border); border-radius:14px; font-family:'Outfit',sans-serif; font-size:14px; font-weight:600; cursor:pointer; margin-top:8px; }
  .form-delete { width:100%; padding:12px; background:rgba(252,92,92,0.1); color:#fc5c5c; border:1px solid rgba(252,92,92,0.3); border-radius:14px; font-family:'Outfit',sans-serif; font-size:14px; font-weight:600; cursor:pointer; margin-top:6px; }

  /* DAY COLOR MODAL */
  .day-color-hint { font-size:13px; color:var(--text2); margin-bottom:16px; line-height:1.5; }
  .day-color-grid { display:grid; grid-template-columns:repeat(4,1fr); gap:10px; margin-bottom:8px; }
  .day-color-opt { aspect-ratio:1; border-radius:14px; cursor:pointer; border:3px solid transparent; transition:all 0.2s; }
  .day-color-opt.selected { border-color:var(--text); transform:scale(1.1); box-shadow:0 4px 16px rgba(0,0,0,0.5); }
  .day-color-opt.clear { background:var(--surface2) !important; border:2px dashed var(--border); display:flex; align-items:center; justify-content:center; font-size:20px; color:var(--text2); }

  /* EMOJI PICKER */
  .emoji-grid { display:grid; grid-template-columns:repeat(7,1fr); gap:6px; max-height:200px; overflow-y:auto; }
  .emoji-opt { font-size:22px; cursor:pointer; text-align:center; padding:5px; border-radius:8px; transition:background 0.15s; }
  .emoji-opt:hover { background:var(--surface2); }

  /* TOAST */
  .toast { position:fixed; top:60px; left:50%; transform:translateX(-50%) translateY(-120px); background:var(--surface); border:1px solid var(--accent); border-radius:16px; padding:12px 16px; display:flex; gap:10px; align-items:center; z-index:999; width:340px; box-shadow:0 8px 30px rgba(0,0,0,0.4); transition:transform 0.4s cubic-bezier(0.16,1,0.3,1); }
  .toast.show { transform:translateX(-50%) translateY(0); }
  .toast-icon { font-size:24px; }
  .toast-text { font-size:13px; font-weight:600; }
  .toast-sub { font-size:11px; color:var(--text2); }
  ::-webkit-scrollbar { width:0; }
</style>
</head>
<body>
<div class="phone-wrapper">
<div class="phone-frame" id="phoneFrame">
  <div class="notch"></div>
  <div class="status-bar"><span id="statusTime">9:41</span><span>ğŸ“¶ ğŸ”‹</span></div>

  <div class="app">

    <!-- CALENDAR VIEW -->
    <div id="calendarView">
      <div class="app-header">
        <div class="app-title">Calendario</div>
        <div style="display:flex;gap:8px;">
          <div class="icon-btn" onclick="toggleLightMode()" id="lightModeBtn" title="Modo claro/oscuro">ğŸŒ™</div>
          <div class="icon-btn" onclick="showNav('settings')">âš™ï¸</div>
        </div>
      </div>
      <div class="month-nav">
        <div class="month-label" id="monthLabel">Febrero 2025</div>
        <div class="nav-arrows">
          <div class="nav-arrow" onclick="changeMonth(-1)">â€¹</div>
          <div class="nav-arrow" onclick="changeMonth(1)">â€º</div>
        </div>
      </div>
      <div class="view-tabs">
        <div class="view-tab active" onclick="setView('monthly',this)">Mensual</div>
        <div class="view-tab" onclick="setView('weekly',this)">Semanal</div>
        <div class="view-tab" onclick="setView('daily',this)">Diario</div>
      </div>

      <div id="monthlyView">
        <div class="calendar-container">
          <div class="weekdays"><div>L</div><div>M</div><div>X</div><div>J</div><div>V</div><div>S</div><div>D</div></div>
          <div class="days-grid" id="daysGrid"></div>
        </div>
        <div id="multiSelectHint" style="padding:6px 20px 0;font-size:11px;color:var(--text2);text-align:center;">ğŸ’¡ Toca dÃ­as para seleccionarlos Â· MantÃ©n pulsado para cambiar su color</div>
        <div id="multiSelectBar" style="display:none;padding:8px 20px;display:flex;gap:8px;align-items:center;">
          <div id="multiSelectCount" style="flex:1;font-size:13px;font-weight:600;color:var(--accent);"></div>
          <button onclick="openDayColorModalMulti()" style="background:var(--gradient);color:white;border:none;border-radius:10px;padding:8px 16px;font-family:'Outfit',sans-serif;font-size:12px;font-weight:700;cursor:pointer;">ğŸ¨ Colorear</button>
          <button onclick="clearMultiSelect()" style="background:var(--surface2);color:var(--text2);border:1px solid var(--border);border-radius:10px;padding:8px 12px;font-family:'Outfit',sans-serif;font-size:12px;cursor:pointer;">âœ• Cancelar</button>
        </div>
        <div class="events-section">
          <div class="section-header">
            <div class="section-title" id="eventsTitle">Hoy</div>
            <button class="add-btn" onclick="openAddModal()">+</button>
          </div>
          <div id="eventsList"></div>
        </div>
      </div>

      <div id="weeklyViewEl" style="display:none">
        <div class="weekly-view">
          <div class="week-row" id="weekRow"></div>
          <div id="weekEventsList" style="margin-top:12px;"></div>
        </div>
      </div>

      <div id="dailyViewEl" style="display:none">
        <div class="daily-view">
          <div class="daily-date" id="dailyDate"></div>
          <div class="daily-date-sub" id="dailyDateSub"></div>
          <div class="timeline" id="timeline"></div>
        </div>
      </div>
    </div>

    <!-- FILTER VIEW (TEMÃTICAS) -->
    <div id="filterView" style="display:none; padding:0 20px;">
      <div class="filter-header">
        <div class="filter-subtitle">Vista por</div>
        <div class="filter-title">TemÃ¡ticas</div>
      </div>
      <div id="catFilterAll"></div>
      <div class="cat-filter-grid" id="catFilterGrid"></div>
      <div class="section-header">
        <div class="section-title" id="filterSectionTitle">Todos los eventos</div>
        <button class="add-btn" onclick="openAddModal()">+</button>
      </div>
      <div id="filterEventsList"></div>
    </div>

    <!-- SETTINGS VIEW -->
    <div class="settings-view" id="settingsView">
      <div class="app-header">
        <div style="display:flex;align-items:center;gap:10px;">
          <div class="icon-btn" onclick="showNav('calendar')">â†</div>
          <div class="app-title" style="font-size:20px;">Ajustes</div>
        </div>
      </div>
      <div>
        <div class="setting-section">
          <div class="setting-section-title">ğŸ¨ Tema</div>
          <div class="theme-grid">
            <div class="theme-card selected" style="background:linear-gradient(135deg,#111120,#18183a);color:#ededff;border-color:#7c5cfc;" id="theme-dark" onclick="setTheme('dark')">
              <div class="theme-preview-dots"><span style="background:#7c5cfc"></span><span style="background:#fc5c8e"></span><span style="background:#ededff"></span></div>
              <div class="theme-card-name">ğŸŒŒ Midnight</div><div class="theme-card-sub">Morado oscuro</div></div>
            <div class="theme-card" style="background:linear-gradient(135deg,#101a12,#16241a);color:#e8f5ec;" id="theme-aurora" onclick="setTheme('aurora')">
              <div class="theme-preview-dots"><span style="background:#6abf80"></span><span style="background:#4a9e6a"></span><span style="background:#e8f5ec"></span></div>
              <div class="theme-card-name">ğŸŒ¿ Sage</div><div class="theme-card-sub">Verde natural</div></div>
            <div class="theme-card" style="background:linear-gradient(135deg,#181200,#221a04);color:#fff8e0;" id="theme-golden" onclick="setTheme('golden')">
              <div class="theme-preview-dots"><span style="background:#f0b830"></span><span style="background:#ff5820"></span><span style="background:#fff8e0"></span></div>
              <div class="theme-card-name">âœ¨ Golden</div><div class="theme-card-sub">Dorado Ã¡mbar</div></div>
            <div class="theme-card" style="background:linear-gradient(135deg,#fff4f7,#ffe8f2);color:#280e1e;" id="theme-sakura" onclick="setTheme('sakura')">
              <div class="theme-preview-dots"><span style="background:#e03870"></span><span style="background:#ff70a0"></span><span style="background:#280e1e"></span></div>
              <div class="theme-card-name">ğŸŒ¸ Sakura</div><div class="theme-card-sub">Rosa japonÃ©s</div></div>
            <div class="theme-card" style="background:linear-gradient(135deg,#041220,#081e34);color:#d0eeff;" id="theme-ocean" onclick="setTheme('ocean')">
              <div class="theme-preview-dots"><span style="background:#28a8ff"></span><span style="background:#28ffe0"></span><span style="background:#d0eeff"></span></div>
              <div class="theme-card-name">ğŸŒŠ Ocean</div><div class="theme-card-sub">Azul profundo</div></div>
            <div class="theme-card" style="background:linear-gradient(135deg,#0e0e0e,#161616);color:#f0f0f0;" id="theme-obsidian" onclick="setTheme('obsidian')">
              <div class="theme-preview-dots"><span style="background:#e0e0e0"></span><span style="background:#808080"></span><span style="background:#f0f0f0"></span></div>
              <div class="theme-card-name">ğŸª¨ Obsidian</div><div class="theme-card-sub">Minimalista</div></div>
          </div>
        </div>
        <div class="setting-section">
          <div class="setting-section-title">ğŸ”” Notificaciones</div>
          <div class="setting-row"><div><div class="setting-row-label">Recordatorios</div><div class="setting-row-sub">Avisar antes de cada evento</div></div><div class="toggle on" onclick="this.classList.toggle('on')"></div></div>
          <div class="setting-row"><div><div class="setting-row-label">Resumen diario</div><div class="setting-row-sub">NotificaciÃ³n a las 8:00 AM</div></div><div class="toggle on" onclick="this.classList.toggle('on')"></div></div>
          <div class="setting-row"><div><div class="setting-row-label">VibraciÃ³n</div><div class="setting-row-sub">Vibrar con alertas</div></div><div class="toggle" onclick="this.classList.toggle('on')"></div></div>
        </div>
        <div class="setting-section">
          <div class="setting-section-title">ğŸ·ï¸ Personalizar categorÃ­as</div>
          <div style="font-size:12px;color:var(--text2);margin-bottom:10px;">Toca el icono para cambiarlo â€¢ Edita el nombre â€¢ Elige el color</div>
          <div id="catsEditorList"></div>
          <button class="add-cat-btn" onclick="addNewCategory()">ï¼‹ Nueva categorÃ­a</button>
        </div>
        <div class="setting-section">
          <div class="setting-section-title">ğŸ“± Acerca de</div>
          <div class="setting-row"><div><div class="setting-row-label">CalenDario v2.0</div><div class="setting-row-sub">Tu calendario personalizado</div></div><span style="font-size:20px;">ğŸ’œ</span></div>
        </div>
      </div>
    </div>

  </div>

  <!-- BOTTOM NAV (4 botones, sin buscar) -->
  <div class="bottom-nav">
    <div class="nav-item active" id="nav-calendar" onclick="showNav('calendar')"><span class="nav-icon">ğŸ“…</span><span>Calendario</span></div>
    <div class="nav-item" id="nav-filter" onclick="showNav('filter')"><span class="nav-icon">ğŸ·ï¸</span><span>TemÃ¡ticas</span></div>
    <div class="nav-item" id="nav-add" onclick="openAddModal()"><span class="nav-icon">â•</span><span>AÃ±adir</span></div>
    <div class="nav-item" id="nav-settings" onclick="showNav('settings')"><span class="nav-icon">âš™ï¸</span><span>Ajustes</span></div>
  </div>
</div>
</div>

<!-- ADD/EDIT EVENT MODAL -->
<div class="modal-overlay" id="addModal">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title" id="modalTitle">Nuevo Evento</div>
    <div class="form-group"><label class="form-label">Nombre del evento</label><input class="form-input" id="inp-name" type="text" placeholder="Ej: ReuniÃ³n de trabajo..."></div>
    <div class="form-group"><label class="form-label">Fecha</label><input class="form-input" id="inp-date" type="date"></div>
    <div class="form-group"><label class="form-label">CategorÃ­a</label><div class="cats-picker" id="catsPicker"></div></div>
    <div class="form-group"><label class="form-label">Color del evento</label><div class="color-picker-row" id="colorPicker"></div></div>
    <div class="form-group"><label class="form-label">Notas</label><textarea class="form-input" id="inp-notes" rows="2" placeholder="Notas adicionales..." style="resize:none;"></textarea></div>
    <button class="form-submit" onclick="saveEvent()">ğŸ’¾ Guardar</button>
    <button class="form-delete" id="deleteEventBtn" style="display:none" onclick="deleteEvent()">ğŸ—‘ï¸ Eliminar evento</button>
    <button class="form-cancel" onclick="closeModal('addModal')">Cancelar</button>
  </div>
</div>

<!-- DAY COLOR MODAL -->
<div class="modal-overlay" id="dayColorModal">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title" id="dayColorTitle">ğŸ¨ Color del dÃ­a</div>
    <div class="day-color-hint">Marca este dÃ­a con un color para identificarlo de un vistazo: dÃ­as libres, vacaciones, dÃ­as especialesâ€¦</div>
    <div class="day-color-grid" id="dayColorGrid"></div>
    <div style="text-align:center;font-size:11px;color:var(--text2);margin-bottom:16px;">Toca ğŸš« para quitar el color</div>
    <button class="form-submit" onclick="saveDayColor()">âœ… Aplicar color</button>
    <button class="form-cancel" onclick="closeModal('dayColorModal')">Cancelar</button>
  </div>
</div>

<!-- EMOJI PICKER MODAL -->
<div class="modal-overlay" id="emojiModal">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title">Elige un icono</div>
    <div class="emoji-grid" id="emojiGrid"></div>
    <button class="form-cancel" style="margin-top:16px;" onclick="closeModal('emojiModal')">Cancelar</button>
  </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast">
  <div class="toast-icon" id="toastIcon">ğŸ””</div>
  <div><div class="toast-text" id="toastText"></div><div class="toast-sub" id="toastSub"></div></div>
</div>

<script>
// ======= STATE =======
let currentDate = new Date();
let selectedDate = new Date();
let currentView = 'monthly';
let currentMainView = 'calendar';
let events = [];
let dayColors = {};
let selectedColor = '#7c5cfc';
let selectedCat = 'personal';
let editingEventId = null;
let editingDayDate = null;
let pendingDayColor = null;
let selectedDates = new Set(); // multi-select for color
let isMultiSelectMode = false;
let emojiTargetCatId = null;
let activeCatFilter = null;

const MONTHS = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
const WDAYS = ['domingo','lunes','martes','miÃ©rcoles','jueves','viernes','sÃ¡bado'];

let categories = [
  { id:'personal', label:'Personal',   icon:'ğŸ’œ', color:'#7c5cfc' },
  { id:'trabajo',  label:'Trabajo',    icon:'ğŸ’¼', color:'#5caafc' },
  { id:'salud',    label:'Salud',      icon:'ğŸ’š', color:'#5cfca0' },
  { id:'social',   label:'Social',     icon:'ğŸ§¡', color:'#fcb85c' },
  { id:'cumple',   label:'CumpleaÃ±os', icon:'ğŸ‚', color:'#fc5c8e' },
  { id:'otro',     label:'Otro',       icon:'â­', color:'#c85cfc' },
];

const colorPalette = ['#7c5cfc','#fc5c8e','#5caafc','#5cfca0','#fcb85c','#fc5c5c','#c85cfc','#5cfce8','#fcdc5c','#fc885c'];

const dayColorOpts = [
  {color:'#5caafc',  emoji:'ğŸ’™', label:'Azul â€“ Trabajo'},
  {color:'#5cfca0',  emoji:'ğŸ’š', label:'Verde â€“ Libre'},
  {color:'#fcb85c',  emoji:'ğŸ§¡', label:'Naranja â€“ Especial'},
  {color:'#fc5c8e',  emoji:'ğŸ©·', label:'Rosa â€“ Personal'},
  {color:'#7c5cfc',  emoji:'ğŸ’œ', label:'Morado â€“ Evento'},
  {color:'#fcdc5c',  emoji:'ğŸ’›', label:'Amarillo â€“ Feriado'},
  {color:'#5cfce8',  emoji:'ğŸ©µ', label:'Cian â€“ Viaje'},
  {color:'#fc5c5c',  emoji:'â¤ï¸', label:'Rojo â€“ Urgente'},
  {color:'#888888',  emoji:'ğŸ©¶', label:'Gris â€“ Neutro'},
  {color:'#c85cfc',  emoji:'ğŸª„', label:'Violeta â€“ MÃ¡gico'},
  {color:'#a0784a',  emoji:'ğŸ¤', label:'MarrÃ³n â€“ ReuniÃ³n'},
  {color:null,       emoji:'ğŸš«', label:'Quitar color'},
];

const emojiList = ['ğŸ˜€','ğŸ˜','ğŸ‰','ğŸ ','ğŸ’¼','ğŸ•','â˜•','ğŸ‹ï¸','ğŸ’Š','ğŸ“š','âœˆï¸','ğŸ‚','ğŸ®','ğŸµ','ğŸŒ¿','ğŸ’','ğŸ¶','ğŸ±','ğŸ¦','ğŸŒˆ','âš½','ğŸ¯','ğŸ†','ğŸ’¡','ğŸ“±','ğŸ’»','ğŸ”‘','ğŸ“','ğŸ¨','ğŸ°','ğŸ','â¤ï¸','ğŸ’œ','ğŸ’›','ğŸ’š','ğŸ’™','ğŸ©·','ğŸ¤','ğŸ–¤','ğŸ’«','â­','ğŸŒŸ','âœ¨','ğŸ”¥','ğŸ’','ğŸŒ™','â˜€ï¸','ğŸŒŠ','ğŸ€','ğŸŒº','ğŸª','ğŸ ','ğŸš—','ğŸš‚','ğŸ­','ğŸ§©','ğŸ–ï¸','ğŸ”ï¸','ğŸ“','ğŸ‘‘'];

// ======= INIT =======
function fmt(d) {
  return d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0');
}

function initDemo() {
  const t = new Date(), y=t.getFullYear(), m=t.getMonth(), d=t.getDate();
  events = [
    {id:1, name:'â˜• CafÃ© con Ana',      date:fmt(new Date(y,m,d)),   start:'09:00',end:'10:00',cat:'social',  color:'#fcb85c',reminder:'30',  notes:'CafeterÃ­a de siempre'},
    {id:2, name:'ğŸ‹ï¸ Gym',              date:fmt(new Date(y,m,d)),   start:'18:00',end:'19:30',cat:'salud',   color:'#5cfca0',reminder:'15',  notes:''},
    {id:3, name:'ğŸ“Š ReuniÃ³n de equipo', date:fmt(new Date(y,m,d+1)),start:'10:00',end:'11:30',cat:'trabajo', color:'#5caafc',reminder:'60',  notes:'Preparar informe Q4'},
    {id:4, name:'ğŸ‚ CumpleaÃ±os MamÃ¡',   date:fmt(new Date(y,m,d+2)),start:'20:00',end:'23:00',cat:'cumple',  color:'#fc5c8e',reminder:'1440',notes:'Comprar pastel'},
    {id:5, name:'ğŸ’Š MÃ©dico',            date:fmt(new Date(y,m,d+5)),start:'11:00',end:'12:00',cat:'salud',   color:'#5cfca0',reminder:'60',  notes:'Traer anÃ¡lisis'},
    {id:6, name:'ğŸ’» Proyecto Web',      date:fmt(new Date(y,m,d+3)),start:'14:00',end:'17:00',cat:'trabajo', color:'#7c5cfc',reminder:'15',  notes:'Entregar maqueta'},
    {id:7, name:'ğŸ‚ Cumple Pedro',      date:fmt(new Date(y,m,d+8)),start:'19:00',end:'23:00',cat:'cumple',  color:'#fc5c8e',reminder:'1440',notes:'Reserva restaurante'},
  ];
  // Demo day colors
  dayColors[fmt(new Date(y,m,d+2))] = '#fcb85c';
  dayColors[fmt(new Date(y,m,d+5))] = '#5cfca0';
  // MiÃ©rcoles y jueves del mes como dÃ­as libres de ejemplo
  for (let dd=1; dd<=28; dd++) {
    const date = new Date(y,m,dd);
    if (date.getDay()===3 || date.getDay()===4) {
      if (!dayColors[fmt(date)]) dayColors[fmt(date)] = '#5cfca0';
    }
  }
}

// ======= CALENDAR =======
function renderCalendar() {
  const y=currentDate.getFullYear(), m=currentDate.getMonth();
  document.getElementById('monthLabel').textContent = MONTHS[m]+' '+y;
  // Monday-first: shift Sunday(0) to position 6, Mon(1)â†’0, Tue(2)â†’1...
  const rawFirst = new Date(y,m,1).getDay();
  const firstDay = (rawFirst + 6) % 7;
  const daysInMonth = new Date(y,m+1,0).getDate();
  const daysInPrev = new Date(y,m,0).getDate();
  const todayStr = fmt(new Date());
  let html='';
  for (let i=firstDay-1;i>=0;i--) {
    const df=fmt(new Date(y,m-1,daysInPrev-i));
    html+=`<div class="day-cell other-month" onclick="selectDate('${df}')">${daysInPrev-i}</div>`;
  }
  for (let d=1;d<=daysInMonth;d++) {
    const df=fmt(new Date(y,m,d));
    const isToday=df===todayStr, isSel=df===fmt(selectedDate);
    const dc=dayColors[df];
    const dayEvts=events.filter(e=>e.date===df);
    let cls='day-cell';
    let style='';
    if (dc&&!isToday) {
      style=`background:${dc}18; border-color:${dc}50;`;
      cls+=' day-colored';
    }
    if (isToday) cls+=' today';
    if (isSel&&!isToday) cls+=' selected';
    if (selectedDates.has(df)) cls+=' multi-selected';
    const dots=dayEvts.slice(0,3).map(e=>`<div class="event-dot" style="background:${e.color}"></div>`).join('');
    html+=`<div class="${cls}" style="${style}" data-date="${df}" data-color="${dc||''}" onclick="dayCellTap('${df}')">${d}${dayEvts.length?`<div class="event-dots">${dots}</div>`:''}</div>`;
  }
  const cells=firstDay+daysInMonth;
  const rem=cells%7===0?0:7-(cells%7);
  for (let d=1;d<=rem;d++) {
    const df=fmt(new Date(y,m+1,d));
    html+=`<div class="day-cell other-month" onclick="selectDate('${df}')">${d}</div>`;
  }
  document.getElementById('daysGrid').innerHTML=html;
  document.querySelectorAll('#daysGrid .day-cell').forEach(cell => {
    const color = cell.getAttribute('data-color');
    if (!color) return;
    // Triangle+line only for today, rest already have tint background
    if (!cell.classList.contains('today')) return;
    cell.style.overflow = 'hidden';
    const tri = document.createElement('div');
    tri.style.cssText = `position:absolute;top:0;right:0;width:0;height:0;border-style:solid;border-width:0 14px 14px 0;border-color:transparent ${color} transparent transparent;pointer-events:none;z-index:2;`;
    const line = document.createElement('div');
    line.style.cssText = `position:absolute;bottom:0;left:15%;right:15%;height:3px;border-radius:2px;background:${color};pointer-events:none;z-index:2;`;
    cell.appendChild(tri);
    cell.appendChild(line);
  });
  setupLongPress();
  renderEventsList();
  updateMultiSelectBar();
}

function setupLongPress() {
  let timer;
  document.querySelectorAll('#daysGrid .day-cell:not(.other-month)').forEach(cell => {
    const df = cell.getAttribute('data-date');
    if (!df) return;

    const handleLongPress = () => {
      // Long press: open color modal for all selected days (or just this one)
      if (!selectedDates.has(df)) selectedDates.add(df);
      if (selectedDates.size === 0) selectedDates.add(df);
      openDayColorModal(df);
    };

    const handleTap = () => {
      // Short tap: toggle multi-select on this day
      if (selectedDates.has(df)) {
        selectedDates.delete(df);
      } else {
        selectedDates.add(df);
      }
      renderCalendar();
    };

    let moved = false;
    cell.addEventListener('mousedown', () => {
      moved = false;
      timer = setTimeout(() => { handleLongPress(); }, 600);
    });
    cell.addEventListener('mousemove', () => { moved = true; });
    cell.addEventListener('mouseup', () => {
      clearTimeout(timer);
    });
    cell.addEventListener('mouseleave', () => clearTimeout(timer));
    cell.addEventListener('contextmenu', e => { e.preventDefault(); handleLongPress(); });

    cell.addEventListener('touchstart', () => {
      moved = false;
      timer = setTimeout(() => { handleLongPress(); }, 600);
    }, { passive: true });
    cell.addEventListener('touchmove', () => { moved = true; clearTimeout(timer); });
    cell.addEventListener('touchend', () => { clearTimeout(timer); });
  });
}

// Override selectDate to also handle multi-select tap
function dayCellTap(df) {
  if (selectedDates.size > 0) {
    // in selection mode - toggle
    if (selectedDates.has(df)) selectedDates.delete(df);
    else selectedDates.add(df);
    renderCalendar();
  } else {
    selectDate(df);
  }
}

function selectDate(ds) {
  selectedDate=new Date(ds+'T12:00:00');
  renderCalendar();
  if (currentView==='daily') renderDailyView();
  if (currentView==='weekly') renderWeeklyView();
}

function changeMonth(dir) {
  currentDate.setMonth(currentDate.getMonth()+dir);
  renderCalendar();
}

function goToday() {
  currentDate=new Date(); selectedDate=new Date();
  renderCalendar(); renderDailyView(); renderWeeklyView();
}

// ======= EVENTS LIST =======
function renderEventsList() {
  const ds=fmt(selectedDate);
  const dayEvts=events.filter(e=>e.date===ds);
  const isToday=ds===fmt(new Date());
  const dn=WDAYS[selectedDate.getDay()];
  document.getElementById('eventsTitle').textContent = isToday
    ? `Hoy â€“ ${selectedDate.getDate()} ${MONTHS[selectedDate.getMonth()]}`
    : `${dn.charAt(0).toUpperCase()+dn.slice(1)} ${selectedDate.getDate()} ${MONTHS[selectedDate.getMonth()]}`;
  document.getElementById('eventsList').innerHTML=buildEventsHTML(dayEvts);
}

function buildEventsHTML(evts) {
  if (!evts.length) return `<div class="no-events"><div class="no-events-icon">ğŸ—“ï¸</div><div>Sin eventos</div><div style="margin-top:4px;font-size:11px;">Toca + para aÃ±adir uno</div></div>`;
  return evts.sort((a,b)=>a.start.localeCompare(b.start)).map(e=>{
    const cat=categories.find(c=>c.id===e.cat);
    return `<div class="event-card" onclick="editEvent(${e.id})" style="border-left:4px solid ${e.color}">
      <div class="event-info">
        <div class="event-name">${e.name}</div>
        <div class="event-meta">
          <span class="event-cat-badge" style="background:${e.color}22;color:${e.color}">${cat?cat.icon+' '+cat.label:e.cat}</span>
        </div>
      </div>
    </div>`;
  }).join('');
}

function remLabel(v) { return {'5':'5min','15':'15min','30':'30min','60':'1h','1440':'1 dÃ­a'}[v]||v; }

// ======= WEEKLY =======
function renderWeeklyView() {
  const dow=selectedDate.getDay();
  const ws=new Date(selectedDate); ws.setDate(selectedDate.getDate()-dow);
  const todayStr=fmt(new Date());
  const wn=['D','L','M','X','J','V','S'];
  let html='';
  for (let i=0;i<7;i++) {
    const d=new Date(ws); d.setDate(ws.getDate()+i);
    const df=fmt(d), isToday=df===todayStr, dc=dayColors[df];
    const de=events.filter(e=>e.date===df);
    let numStyle='';
    if (dc&&!isToday) numStyle=`background:${dc};color:white;border-radius:8px;`;
    html+=`<div class="week-day-col">
      <div class="week-day-header" onclick="selectDate('${df}')">
        <div class="week-day-name">${wn[i]}</div>
        <div class="week-day-num${isToday?' today':''}" style="${numStyle}">${d.getDate()}</div>
      </div>
      ${de.slice(0,3).map(e=>`<div class="week-event-pill" style="background:${e.color}" onclick="editEvent(${e.id})">${e.name.substring(0,7)}</div>`).join('')}
      ${!de.length?'<div class="week-empty-slot"></div>':''}
    </div>`;
  }
  document.getElementById('weekRow').innerHTML=html;
  const all=[];
  for (let i=0;i<7;i++) { const d=new Date(ws);d.setDate(ws.getDate()+i); events.filter(e=>e.date===fmt(d)).forEach(e=>all.push({...e,_d:d})); }
  all.sort((a,b)=>a.date.localeCompare(b.date)||a.start.localeCompare(b.start));
  if (!all.length) { document.getElementById('weekEventsList').innerHTML=`<div class="no-events"><div class="no-events-icon">ğŸ“…</div><div>Sin eventos esta semana</div></div>`; return; }
  document.getElementById('weekEventsList').innerHTML=`<div class="section-header"><div class="section-title">Esta semana</div><button class="add-btn" onclick="openAddModal()">+</button></div>`+all.map(e=>{
    const cat=categories.find(c=>c.id===e.cat), dn=WDAYS[e._d.getDay()];
    return `<div class="event-card" onclick="editEvent(${e.id})" style="border-left:4px solid ${e.color}">
      <div class="event-info"><div class="event-name">${e.name}</div>
      <div class="event-meta"><span style="color:${e.color};font-weight:700;font-size:11px;">${dn.substring(0,3)} ${e._d.getDate()}</span> <span class="event-cat-badge" style="background:${e.color}22;color:${e.color}">${cat?cat.icon+' '+cat.label:e.cat}</span></div></div>
      
    </div>`;
  }).join('');
}

// ======= DAILY =======
function renderDailyView() {
  const d=selectedDate, df=fmt(d), dc=dayColors[df];
  document.getElementById('dailyDate').textContent=`${d.getDate()} ${MONTHS[d.getMonth()]}`;
  document.getElementById('dailyDateSub').textContent=`${WDAYS[d.getDay()].charAt(0).toUpperCase()+WDAYS[d.getDay()].slice(1)}, ${d.getFullYear()}`;
  const dayEvts=events.filter(e=>e.date===df).sort((a,b)=>a.start.localeCompare(b.start));
  let html='';
  if (dc) html+=`<div style="background:${dc};border-radius:12px;padding:8px 14px;margin-bottom:12px;color:white;font-size:12px;font-weight:700;display:flex;align-items:center;gap:8px;cursor:pointer;" onclick="openDayColorModal('${df}')">ğŸ¨ DÃ­a con color marcado <span style="opacity:0.8;font-weight:400;">Â· Toca para cambiar</span></div>`;
  const hours=[6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22];
  hours.forEach(h=>{
    const se=dayEvts.filter(e=>e.start>=String(h).padStart(2,'0')+':00'&&e.start<String(h+1).padStart(2,'0')+':00');
    html+=`<div class="time-slot"><div class="time-label">${h>12?h-12+'pm':h===12?'12pm':h+'am'}</div><div class="time-line">${se.map(e=>`<div class="timeline-event" style="background:${e.color}" onclick="editEvent(${e.id})"><div>${e.name}</div><div class="timeline-event-time">${e.start}${e.end?' â€“ '+e.end:''}</div></div>`).join('')}</div></div>`;
  });
  if (!dayEvts.length) html+=`<div class="no-events" style="margin-top:20px"><div class="no-events-icon">ğŸŒŸ</div><div>DÃ­a libre</div><div style="margin-top:4px;font-size:11px;">Toca + para aÃ±adir</div></div>`;
  document.getElementById('timeline').innerHTML=html;
}

// ======= FILTER VIEW =======
function renderFilterView() {
  // "Todos" button
  document.getElementById('catFilterAll').innerHTML=`<div class="cat-filter-all ${activeCatFilter===null?'active':''}" onclick="setCatFilter(null)">
    <span style="font-size:24px;">ğŸ—‚ï¸</span>
    <div><div style="font-size:13px;font-weight:700;">Todos</div><div style="font-size:11px;color:var(--text2)">${events.length} evento${events.length!==1?'s':''}</div></div>
  </div>`;
  // Category cards
  document.getElementById('catFilterGrid').innerHTML=categories.map(c=>{
    const cnt=events.filter(e=>e.cat===c.id).length;
    const active=activeCatFilter===c.id;
    return `<div class="cat-filter-card ${active?'active':''}" style="background:${c.color}18;color:${c.color};" onclick="setCatFilter('${c.id}')">
      <div class="cat-filter-icon">${c.icon}</div>
      <div class="cat-filter-name">${c.label}</div>
      <div class="cat-filter-count">${cnt} evento${cnt!==1?'s':''}</div>
    </div>`;
  }).join('');

  // Events list grouped by month
  const filtered=activeCatFilter?events.filter(e=>e.cat===activeCatFilter):[...events];
  const catObj=activeCatFilter?categories.find(c=>c.id===activeCatFilter):null;
  document.getElementById('filterSectionTitle').textContent=catObj?`${catObj.icon} ${catObj.label}`:'Todos los eventos';

  if (!filtered.length) {
    document.getElementById('filterEventsList').innerHTML=`<div class="no-events"><div class="no-events-icon">ğŸ·ï¸</div><div>Sin eventos en esta categorÃ­a</div><div style="margin-top:4px;font-size:11px;">Toca + para aÃ±adir uno</div></div>`;
    return;
  }
  const byMonth={};
  filtered.sort((a,b)=>a.date.localeCompare(b.date)||a.start.localeCompare(b.start)).forEach(e=>{
    const k=e.date.substring(0,7);
    if(!byMonth[k]) byMonth[k]=[];
    byMonth[k].push(e);
  });
  let html='';
  Object.keys(byMonth).forEach(k=>{
    const [y,m]=k.split('-');
    html+=`<div class="filter-month-group"><div class="filter-month-header">${MONTHS[parseInt(m)-1]} ${y}</div>`;
    html+=byMonth[k].map(e=>{
      const cat=categories.find(c=>c.id===e.cat);
      const d=new Date(e.date+'T12:00');
      const dc=dayColors[e.date];
      return `<div class="event-card" onclick="editEvent(${e.id})" style="border-left:4px solid ${e.color}">
        <div style="font-size:22px;flex-shrink:0">${cat?cat.icon:'ğŸ“Œ'}</div>
        <div class="event-info">
          <div class="event-name">${e.name}</div>
          <div class="event-meta">
            <span style="font-weight:700;font-size:11px;">${WDAYS[d.getDay()].substring(0,3)} ${d.getDate()}</span>
            ${dc?`<span style="width:10px;height:10px;border-radius:50%;background:${dc};display:inline-block;"></span>`:''}
            ${cat&&!activeCatFilter?`<span class="event-cat-badge" style="background:${e.color}22;color:${e.color}">${cat.icon} ${cat.label}</span>`:''}
          </div>
        </div>
        
      </div>`;
    }).join('');
    html+='</div>';
  });
  document.getElementById('filterEventsList').innerHTML=html;
}

function setCatFilter(id) {
  activeCatFilter=id;
  renderFilterView();
}

// ======= VIEW SWITCH =======
function setView(view,tab) {
  currentView=view;
  document.querySelectorAll('.view-tab').forEach(t=>t.classList.remove('active'));
  tab.classList.add('active');
  document.getElementById('monthlyView').style.display  =view==='monthly'?'block':'none';
  document.getElementById('weeklyViewEl').style.display =view==='weekly'?'block':'none';
  document.getElementById('dailyViewEl').style.display  =view==='daily'?'block':'none';
  if (view==='weekly') renderWeeklyView();
  if (view==='daily')  renderDailyView();
}

function showNav(view) {
  currentMainView=view;
  document.getElementById('calendarView').style.display ='none';
  document.getElementById('filterView').style.display   ='none';
  document.getElementById('settingsView').style.display ='none';
  if (view==='calendar')  document.getElementById('calendarView').style.display='block';
  if (view==='filter')    document.getElementById('filterView').style.display='block';
  if (view==='settings')  document.getElementById('settingsView').style.display='block';
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
  const map={calendar:'nav-calendar',filter:'nav-filter',settings:'nav-settings'};
  if (map[view]) document.getElementById(map[view]).classList.add('active');
  if (view==='filter')   renderFilterView();
  if (view==='settings') renderCatsEditor();
}

// ======= DAY COLOR MODAL =======
// Simple universal palette - rendered as tints so they always fit any theme
const dayColorPalette = [
  {color:'#ff4444', label:'Rojo'},
  {color:'#ff8c00', label:'Naranja'},
  {color:'#ffd700', label:'Amarillo'},
  {color:'#44cc44', label:'Verde'},
  {color:'#00aaff', label:'Azul'},
  {color:'#aa44ff', label:'Morado'},
  {color:'#ff44aa', label:'Rosa'},
  {color:'#00cccc', label:'Cian'},
  {color:'#ff6644', label:'Coral'},
  {color:'#88cc00', label:'Lima'},
  {color:'#ff99cc', label:'Rosa pÃ¡lido'},
  {color:null,      label:'Quitar'},
];

function openDayColorModal(ds) {
  editingDayDate=ds;
  pendingDayColor=dayColors[ds]||null;
  const count = selectedDates.size;
  if (count > 1) {
    document.getElementById('dayColorTitle').textContent = `ğŸ¨ ${count} dÃ­as seleccionados`;
  } else {
    const d=new Date(ds+'T12:00');
    document.getElementById('dayColorTitle').textContent=`ğŸ¨ ${WDAYS[d.getDay()].charAt(0).toUpperCase()+WDAYS[d.getDay()].slice(1)} ${d.getDate()} ${MONTHS[d.getMonth()]}`;
  }
  document.getElementById('dayColorGrid').innerHTML = dayColorPalette.map(opt => {
    const isSelected = pendingDayColor === opt.color;
    if (opt.color === null) {
      return `<div class="day-color-opt clear ${isSelected?'selected':''}" onclick="selDayColor(null)" title="Quitar color">ğŸš«</div>`;
    }
    return `<div class="day-color-opt ${isSelected?'selected':''}"
      style="background:${opt.color}30; border:2px solid ${opt.color}80;"
      onclick="selDayColor('${opt.color}')"
      title="${opt.label}">
      <div style="width:18px;height:18px;border-radius:6px;background:${opt.color};margin:auto;"></div>
    </div>`;
  }).join('');
  document.getElementById('dayColorModal').classList.add('open');
}

function selDayColor(color) {
  pendingDayColor = color;
  document.querySelectorAll('.day-color-opt').forEach(el => {
    const elColor = el.style.background || null;
    el.classList.toggle('selected', el.style.background === color || (color === null && el.classList.contains('clear')));
  });
}

function saveDayColor() {
  const targets = selectedDates.size > 0 ? [...selectedDates] : [editingDayDate];
  targets.forEach(date => {
    if (pendingDayColor===null) delete dayColors[date];
    else dayColors[date]=pendingDayColor;
  });
  selectedDates.clear();
  closeModal('dayColorModal');
  refreshAll();
  const n = targets.length;
  showToast('ğŸ¨', n>1?`${n} dÃ­as actualizados`:'DÃ­a actualizado', pendingDayColor?'Color aplicado':'Color eliminado');
}

// ======= EVENT MODAL =======
function openAddModal() {
  editingEventId=null;
  document.getElementById('modalTitle').textContent='Nuevo Evento';
  document.getElementById('inp-name').value='';
  document.getElementById('inp-date').value=fmt(selectedDate);
  document.getElementById('inp-notes').value='';
  document.getElementById('deleteEventBtn').style.display='none';
  selectedCat=categories[0]?.id||'personal';
  selectedColor=categories[0]?.color||'#7c5cfc';
  renderFormCats(); renderFormColors();
  document.getElementById('addModal').classList.add('open');
}

function editEvent(id) {
  const e=events.find(ev=>ev.id===id);
  if (!e) return;
  editingEventId=id;
  document.getElementById('modalTitle').textContent='Editar Evento';
  document.getElementById('inp-name').value=e.name;
  document.getElementById('inp-date').value=e.date;
  document.getElementById('inp-notes').value=e.notes||'';
  document.getElementById('deleteEventBtn').style.display='block';
  selectedCat=e.cat; selectedColor=e.color;
  renderFormCats(); renderFormColors();
  document.getElementById('addModal').classList.add('open');
}

function deleteEvent() {
  const e=events.find(ev=>ev.id===editingEventId);
  events=events.filter(ev=>ev.id!==editingEventId);
  closeModal('addModal'); refreshAll();
  showToast('ğŸ—‘ï¸','Evento eliminado',e?.name||'');
}

function saveEvent() {
  const name=document.getElementById('inp-name').value.trim();
  if (!name) { showToast('âš ï¸','Nombre requerido','Escribe un nombre'); return; }
  const dateVal=document.getElementById('inp-date').value;
  const ev={id:editingEventId||Date.now(),name,
    date:dateVal,
    start:'', end:'',
    cat:selectedCat, color:selectedColor,
    recurring: selectedCat==='cumple' ? 'yearly' : null,
    notes:document.getElementById('inp-notes').value,
  };
  if (editingEventId) {
    events=events.filter(e=>!(e.recurringFrom===editingEventId));
    events=events.map(e=>e.id===editingEventId?ev:e);
    showToast('âœ…','Actualizado',ev.name);
  } else {
    events.push(ev);
    // If birthday, auto-create for next 9 years
    if (selectedCat==='cumple' && dateVal) {
      const [y,mo,d]=dateVal.split('-').map(Number);
      for (let i=1;i<=9;i++) {
        const nextDate=`${y+i}-${String(mo).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
        events.push({id:Date.now()+i,name,date:nextDate,start:'',end:'',
          cat:selectedCat,color:selectedColor,recurring:'yearly',recurringFrom:ev.id,notes:ev.notes});
      }
      showToast('ğŸ‚','CumpleaÃ±os creado',`Se guardarÃ¡ cada aÃ±o automÃ¡ticamente`);
    } else {
      showToast('ğŸ‰','Evento creado',ev.name);
    }
  }
  closeModal('addModal'); refreshAll();
}

function renderFormCats() {
  document.getElementById('catsPicker').innerHTML=categories.map(c=>
    `<div class="cat-pill ${selectedCat===c.id?'selected':''}" style="background:${c.color}22;color:${c.color}" onclick="selectCat('${c.id}')">${c.icon} ${c.label}</div>`
  ).join('');
}
function selectCat(id) {
  selectedCat=id;
  const cat=categories.find(c=>c.id===id);
  if (cat) selectedColor=cat.color;
  renderFormCats(); renderFormColors();
}
function renderFormColors() {
  document.getElementById('colorPicker').innerHTML=colorPalette.map(c=>
    `<div class="color-swatch ${selectedColor===c?'selected':''}" style="background:${c}" onclick="selColor('${c}')"></div>`
  ).join('');
}
function selColor(c) { selectedColor=c; renderFormColors(); }

// ======= CATEGORY EDITOR =======
function renderCatsEditor() {
  document.getElementById('catsEditorList').innerHTML=categories.map(c=>
    `<div class="cat-edit-row">
      <div class="cat-edit-top">
        <div class="cat-icon-big" onclick="openEmojiPicker('${c.id}')" title="Cambiar icono">${c.icon}</div>
        <input class="cat-name-input" id="cn-${c.id}" value="${c.label}" oninput="updateCatName('${c.id}',this.value)" placeholder="Nombre...">
        <button class="cat-delete-btn" onclick="deleteCat('${c.id}')" title="Eliminar categorÃ­a">ğŸ—‘ï¸</button>
      </div>
      <div class="cat-color-dots">
        ${colorPalette.map(col=>`<div class="cat-color-dot ${c.color===col?'selected':''}" style="background:${col}" onclick="updateCatColor('${c.id}','${col}')"></div>`).join('')}
      </div>
    </div>`
  ).join('');
}

function updateCatName(id,name) {
  const cat=categories.find(c=>c.id===id);
  if (cat) { cat.label=name; refreshAll(); }
}
function updateCatColor(id,color) {
  const cat=categories.find(c=>c.id===id);
  if (cat) { cat.color=color; renderCatsEditor(); refreshAll(); showToast('ğŸ¨','Color cambiado',cat.icon+' '+cat.label); }
}
function deleteCat(id) {
  if (categories.length<=1) { showToast('âš ï¸','MÃ­nimo 1 categorÃ­a','No puedes eliminar todas'); return; }
  const cat=categories.find(c=>c.id===id);
  categories=categories.filter(c=>c.id!==id);
  events=events.map(e=>e.cat===id?{...e,cat:categories[0].id}:e);
  renderCatsEditor(); refreshAll();
  showToast('ğŸ—‘ï¸','CategorÃ­a eliminada',cat?.label||'');
}
function addNewCategory() {
  const nid='cat_'+Date.now();
  categories.push({id:nid,label:'Nueva',icon:'ğŸ“Œ',color:'#7c5cfc'});
  renderCatsEditor();
  setTimeout(()=>{ const inp=document.getElementById('cn-'+nid); if(inp){inp.focus();inp.select();} },100);
}

// ======= EMOJI PICKER =======
function openEmojiPicker(catId) {
  emojiTargetCatId=catId;
  document.getElementById('emojiGrid').innerHTML=emojiList.map(e=>`<div class="emoji-opt" onclick="selectEmoji('${e}')">${e}</div>`).join('');
  document.getElementById('emojiModal').classList.add('open');
}
function selectEmoji(emoji) {
  const cat=categories.find(c=>c.id===emojiTargetCatId);
  if (cat) { cat.icon=emoji; renderCatsEditor(); refreshAll(); }
  closeModal('emojiModal');
  showToast(emoji,'Icono actualizado','');
}

function clearMultiSelect() {
  selectedDates.clear();
  renderCalendar();
}

function openDayColorModalMulti() {
  if (selectedDates.size === 0) return;
  const first = [...selectedDates][0];
  openDayColorModal(first);
}

function updateMultiSelectBar() {
  const bar = document.getElementById('multiSelectBar');
  const hint = document.getElementById('multiSelectHint');
  const count = selectedDates.size;
  if (!bar) return;
  if (count > 0) {
    bar.style.display='flex';
    if(hint) hint.style.display='none';
    document.getElementById('multiSelectCount').textContent = `${count} dÃ­a${count>1?'s':''} seleccionado${count>1?'s':''}`;
  } else {
    bar.style.display='none';
    if(hint) hint.style.display='block';
  }
}

// ======= DARK/LIGHT MODE =======
let isLightMode = false;
function toggleLightMode() {
  isLightMode = !isLightMode;
  document.body.classList.toggle('light-mode', isLightMode);
  // Also force body bg update
  document.body.style.background = '';
  document.getElementById('lightModeBtn').textContent = isLightMode ? 'â˜€ï¸' : 'ğŸŒ™';
  showToast(isLightMode ? 'â˜€ï¸' : 'ğŸŒ™', isLightMode ? 'Modo claro' : 'Modo oscuro', '');
}

// ======= SETTINGS =======
function setTheme(t) {
  document.getElementById('phoneFrame').setAttribute('data-theme', t==='dark'?'':t);
  document.querySelectorAll('.theme-card').forEach(c=>c.classList.remove('selected'));
  document.getElementById('theme-'+t).classList.add('selected');
  showToast('ğŸ¨','Tema cambiado','');
}

// ======= MODAL CLOSE =======
function closeModal(id) { document.getElementById(id).classList.remove('open'); }
['addModal','dayColorModal','emojiModal'].forEach(id=>{
  document.getElementById(id).addEventListener('click',function(e){ if(e.target===this)closeModal(id); });
});

// ======= REFRESH ALL =======
function refreshAll() {
  renderCalendar();
  if (currentView==='weekly') renderWeeklyView();
  if (currentView==='daily') renderDailyView();
  if (currentMainView==='filter') renderFilterView();
}

// ======= TOAST =======
function showToast(icon,text,sub) {
  document.getElementById('toastIcon').textContent=icon;
  document.getElementById('toastText').textContent=text;
  document.getElementById('toastSub').textContent=sub;
  const t=document.getElementById('toast');
  t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),3500);
}

// ======= CLOCK =======
function updateClock() {
  const n=new Date();
  document.getElementById('statusTime').textContent=String(n.getHours()).padStart(2,'0')+':'+String(n.getMinutes()).padStart(2,'0');
}
setInterval(updateClock,30000); updateClock();

// ======= BOOT =======
renderCalendar();

// ======= SERVICE WORKER =======
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('./sw.js').catch(()=>{});
}
</script>
</body>
</html>
